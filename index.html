<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus HR - Team Collaboration Suite</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'DM Sans', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease, opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(20px); opacity: 0; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; }
        .prose strong { color: #4318FF; }
        .prose-invert strong { color: #818cf8; }
        .prose-invert ul { list-style-type: disc; padding-left: 1.2rem; color: #cbd5e1; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #05CD99; box-shadow: 0 0 0 2px rgba(5, 205, 153, 0.2); }
        .status-busy { background-color: #EE5D50; box-shadow: 0 0 0 2px rgba(238, 93, 80, 0.2); }
        .status-dnd { background-color: #FFB547; box-shadow: 0 0 0 2px rgba(255, 181, 71, 0.2); }
        .graph-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-[#F4F7FE] text-[#2B3674] h-screen flex flex-col overflow-hidden">

    <div id="app" class="h-full flex flex-col">
        
        <header class="bg-[#4318FF] text-white z-20 shadow-md flex-shrink-0 relative overflow-hidden">
            <div class="px-6 py-4 flex justify-between items-center relative z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-xl backdrop-blur-sm">
                        <i class="fa-solid fa-layer-group text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight tracking-wide">Nexus HR</h1>
                        <p class="text-[10px] text-indigo-100 font-medium tracking-wider opacity-80 uppercase">Team Suite v7.5</p>
                    </div>
                </div>
                
                <div class="hidden md:block bg-white/10 px-4 py-2 rounded-lg backdrop-blur-sm border border-white/20">
                    <p class="text-xs font-bold text-indigo-100 uppercase tracking-wider">Current Time (IST)</p>
                    <p class="text-sm font-bold font-mono">{{ currentTimeIST }}</p>
                </div>

                <div v-if="currentUser" class="flex items-center gap-4">
                    <button v-if="isSystemInCall && !inCall" @click="joinCall" class="animate-pulse bg-[#05CD99] text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-video"></i> Join Team Call
                    </button>

                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold">{{ currentUser.name }}</p>
                        <p class="text-xs text-indigo-200 font-medium">{{ currentUser.role }}</p>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-white/20 border border-white/30 overflow-hidden flex items-center justify-center relative">
                        <img v-if="currentUser.photo" :src="currentUser.photo" class="w-full h-full object-cover">
                        <span v-else class="text-sm font-bold">{{ currentUser.name.charAt(0) }}</span>
                        <div class="absolute bottom-0 right-0 w-3 h-3 border-2 border-[#4318FF] rounded-full"
                             :class="statusColorClass(currentUser.status)"></div>
                    </div>
                    <button @click="logout" title="Logout" class="bg-white/10 hover:bg-red-500 hover:text-white p-2.5 rounded-full transition-all text-white/80">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </div>
        </header>

        <transition name="slide-up">
            <div v-if="showNotification" class="fixed top-20 right-6 z-50 bg-white p-4 rounded-xl shadow-2xl border-l-4 border-[#4318FF] max-w-sm flex items-start gap-3">
                <div class="text-[#4318FF] text-xl mt-1"><i class="fa-solid fa-bell"></i></div>
                <div>
                    <h4 class="font-bold text-sm text-[#2B3674]">New Notification</h4>
                    <p class="text-xs text-gray-600">{{ notificationMessage }}</p>
                    <button v-if="notificationType === 'call'" @click="joinCallFromNotif" class="mt-2 text-xs bg-[#05CD99] text-white px-3 py-1 rounded-lg font-bold">Join Call</button>
                    <button v-if="notificationType === 'task'" @click="goToGoalsFromNotif" class="mt-2 text-xs bg-[#4318FF] text-white px-3 py-1 rounded-lg font-bold">View Goals</button>
                </div>
                <button @click="showNotification = false" class="ml-auto text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showPasswordPrompt" class="fixed inset-0 z-50 flex items-center justify-center bg-[#111C44]/50 backdrop-blur-sm p-4">
                <div class="bg-white p-6 rounded-[20px] shadow-2xl w-full max-w-sm text-center">
                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-[#4318FF] text-xl">
                        <i class="fa-solid fa-key"></i>
                    </div>
                    <h3 class="font-bold text-lg text-[#2B3674]">Save Password?</h3>
                    <p class="text-xs text-gray-500 mt-2 mb-6">Would you like Nexus HR to remember your password for next time?</p>
                    <div class="flex gap-3">
                        <button @click="handleSavePassword(false)" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl text-sm font-bold hover:bg-gray-200">No</button>
                        <button @click="handleSavePassword(true)" class="flex-1 py-3 bg-[#4318FF] text-white rounded-xl text-sm font-bold hover:bg-indigo-700">Yes, Save</button>
                    </div>
                </div>
            </div>
        </transition>

        <div v-if="!currentUser" class="flex-1 flex items-center justify-center p-4 bg-[#F4F7FE]">
            <div class="bg-white p-8 rounded-[20px] shadow-2xl w-full max-w-md relative z-10">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-[#4318FF] rounded-2xl mx-auto flex items-center justify-center text-white text-3xl mb-4 shadow-lg shadow-indigo-500/40">
                        <i class="fa-solid fa-fingerprint"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-[#2B3674]">Welcome Back</h2>
                    <p class="text-[#A3AED0] text-sm mt-1">Enter your details to access the workspace.</p>
                </div>
                <div class="bg-[#F4F7FE] p-1 rounded-xl flex mb-6">
                    <button @click="activeLoginPortal = 'employee'" :class="activeLoginPortal === 'employee' ? 'bg-white text-[#4318FF] shadow-sm' : 'text-[#A3AED0] hover:text-[#2B3674]'" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all">Employee</button>
                    <button @click="activeLoginPortal = 'hr'" :class="activeLoginPortal === 'hr' ? 'bg-white text-[#4318FF] shadow-sm' : 'text-[#A3AED0] hover:text-[#2B3674]'" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all">HR Admin</button>
                </div>
                <form @submit.prevent="login" class="space-y-5">
                    <div>
                        <label class="text-xs font-bold text-[#A3AED0] uppercase ml-1">User ID</label>
                        <input v-model="loginForm.id" type="text" :placeholder="activeLoginPortal === 'hr' ? 'hr01' : 'emp01'" class="w-full mt-1 p-4 bg-[#F4F7FE] rounded-xl text-sm font-medium text-[#2B3674] focus:outline-none focus:ring-2 focus:ring-[#4318FF] transition-all placeholder-[#A3AED0]">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-[#A3AED0] uppercase ml-1">Password</label>
                        <input v-model="loginForm.password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full mt-1 p-4 bg-[#F4F7FE] rounded-xl text-sm font-medium text-[#2B3674] focus:outline-none focus:ring-2 focus:ring-[#4318FF] transition-all placeholder-[#A3AED0]">
                    </div>
                    <button type="submit" class="w-full bg-[#4318FF] hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/40 transition-transform active:scale-95">Sign In</button>
                </form>
            </div>
        </div>

        <div v-else class="flex-1 flex overflow-hidden">
            <nav class="hidden md:flex flex-col w-64 bg-white h-full shadow-xl relative z-10">
                <div class="p-6 pb-2 flex-shrink-0">
                    <div class="mb-4 bg-[#F4F7FE] p-3 rounded-xl">
                        <label class="text-xs font-bold text-[#A3AED0] uppercase mb-2 block">My Status</label>
                        <select v-model="currentUser.status" @change="updateStatus" class="w-full bg-white text-xs font-bold p-2 rounded-lg outline-none text-[#2B3674] border border-transparent focus:border-[#4318FF]">
                            <option value="Online">üü¢ Online</option>
                            <option value="Busy">üî¥ Busy</option>
                            <option value="DND">‚õî Do Not Disturb</option>
                        </select>
                    </div>
                    <p class="text-xs font-bold text-[#A3AED0] uppercase tracking-wider pl-2">Menu</p>
                </div>

                <div class="flex-1 overflow-y-auto px-6 space-y-2 custom-scroll">
                    <button @click="activeTab = 'home'" :class="navClass('home')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all font-bold text-sm"><i class="fa-solid fa-house text-lg"></i> Dashboard</button>
                    <button @click="activeTab = 'leave'" :class="navClass('leave')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all font-bold text-sm"><i class="fa-solid fa-calendar-check text-lg"></i> {{ currentUser.role === 'HR Admin' ? 'Leave Requests' : 'Leave & Time' }}</button>
                    <button @click="activeTab = 'tickets'" :class="navClass('tickets')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all font-bold text-sm"><i class="fa-solid fa-ticket text-lg"></i> Help Desk</button>
                    <button @click="activeTab = 'team'" :class="navClass('team')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all font-bold text-sm"><i class="fa-solid fa-video text-lg"></i> Team Hub</button>
                    <button @click="activeTab = 'docs'" :class="navClass('docs')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all font-bold text-sm"><i class="fa-solid fa-folder-open text-lg"></i> Documents</button>
                    <button @click="activeTab = 'goals'" :class="navClass('goals')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all font-bold text-sm"><i class="fa-solid fa-bullseye text-lg"></i> {{ currentUser.role === 'HR Admin' ? 'Assign Goals' : 'My Goals' }}</button>
                    <button @click="activeTab = 'profile'" :class="navClass('profile')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all font-bold text-sm"><i class="fa-solid fa-user text-lg"></i> My Profile</button>
                </div>

                <div class="mt-auto p-6 flex-shrink-0">
                    <div class="bg-gradient-to-b from-[#868CFF] to-[#4318FF] rounded-2xl p-5 text-white relative overflow-hidden shadow-lg shadow-indigo-500/40 text-center">
                        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm"><i class="fa-solid fa-robot text-lg"></i></div>
                        <h4 class="font-bold text-sm mb-1">Need Help?</h4>
                        <p class="text-[10px] text-white/80 mb-4 px-2 leading-relaxed">Ask our AI assistant about company policies.</p>
                        <button @click="toggleChat" class="w-full bg-white text-[#4318FF] text-xs font-bold py-2.5 rounded-lg hover:bg-white/90 transition-colors shadow-sm"><i class="fa-regular fa-comment-dots mr-1"></i> Open Chat</button>
                    </div>
                </div>
            </nav>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll relative">
                
                <button @click="toggleChat" class="fixed bottom-6 right-6 w-14 h-14 bg-[#4318FF] hover:bg-indigo-700 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 transition-transform active:scale-95">
                    <i class="fa-solid fa-comment-dots"></i>
                </button>

                <div v-if="activeTab === 'home'" class="max-w-7xl mx-auto">
                    <div v-if="currentUser.role !== 'HR Admin'">
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                             <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6 h-40">
                                <div class="bg-white p-5 rounded-[20px] shadow-sm flex flex-col justify-between relative">
                                    <div class="flex justify-between items-start">
                                        <div><p class="text-xs font-bold text-[#A3AED0] uppercase">Annual Leave</p><h3 class="text-3xl font-bold text-[#2B3674]">{{ currentUser.leaveBalance }}</h3></div>
                                        <div class="w-10 h-10 rounded-full bg-[#F4F7FE] flex items-center justify-center text-[#4318FF]"><i class="fa-solid fa-suitcase text-lg"></i></div>
                                    </div>
                                    <div><div class="w-full bg-[#F4F7FE] rounded-full h-2 mb-2"><div class="bg-[#4318FF] h-2 rounded-full" :style="{ width: (currentUser.leaveBalance/20)*100 + '%' }"></div></div></div>
                                </div>
                                <div class="bg-white p-5 rounded-[20px] shadow-sm flex flex-col h-auto col-span-2">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="text-lg font-bold text-[#2B3674]">Quick Tasks</h3>
                                        <div class="flex gap-2">
                                            <input v-model="newTaskText" @keyup.enter="addTask" type="text" placeholder="Add task..." class="bg-[#F4F7FE] text-xs px-3 py-2 rounded-lg outline-none focus:ring-1 focus:ring-[#4318FF]">
                                            <button @click="addTask" class="bg-[#4318FF] text-white w-8 h-8 rounded-lg flex items-center justify-center"><i class="fa-solid fa-plus text-xs"></i></button>
                                        </div>
                                    </div>
                                    <div class="flex-1 overflow-y-auto custom-scroll space-y-2 max-h-[100px]">
                                        <div v-for="task in myTasks" :key="task.id" class="flex items-center gap-3 p-2 rounded-lg hover:bg-[#F4F7FE] cursor-pointer" @click="toggleTask(task)">
                                            <div class="w-4 h-4 rounded border flex items-center justify-center" :class="task.done ? 'bg-[#05CD99] border-transparent text-white' : 'border-[#A3AED0]'"> <i v-if="task.done" class="fa-solid fa-check text-[10px]"></i></div>
                                            <span class="text-sm font-medium" :class="task.done ? 'text-[#A3AED0] line-through' : 'text-[#2B3674]'">{{ task.text }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-bold text-[#2B3674] mb-4">Team Availability</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            <div v-for="emp in allEmployees" :key="emp.id" class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-3 border border-transparent hover:border-[#4318FF] transition-all">
                                <div class="relative">
                                    <div class="w-10 h-10 rounded-full bg-[#F4F7FE] flex items-center justify-center font-bold text-[#4318FF]">{{ emp.name.charAt(0) }}</div>
                                    <div class="absolute bottom-0 right-0 w-3 h-3 border-2 border-white rounded-full" :class="statusColorClass(emp.status)"></div>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-[#2B3674] truncate">{{ emp.name }}</p>
                                    <p class="text-[10px] text-[#A3AED0]">{{ emp.status || 'Online' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'leave'" class="max-w-6xl mx-auto">
                    <div v-if="currentUser.role === 'HR Admin'">
                        <h2 class="text-2xl font-bold text-[#2B3674] mb-6">Manage Leave Requests</h2>
                        <div class="bg-white p-6 rounded-[20px] shadow-sm">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="text-xs text-[#A3AED0] border-b border-gray-100 uppercase">
                                            <th class="p-4">Employee</th>
                                            <th class="p-4">Leave Type</th>
                                            <th class="p-4">Duration</th>
                                            <th class="p-4">Reason</th>
                                            <th class="p-4">Status</th>
                                            <th class="p-4">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm text-[#2B3674]">
                                        <tr v-for="req in allLeaveRequests" :key="req.id" class="border-b border-gray-50 hover:bg-[#F4F7FE]">
                                            <td class="p-4">
                                                <div class="flex items-center gap-2">
                                                    <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-[#4318FF] font-bold text-xs">{{ getInitials(req.empId) }}</div>
                                                    <span class="font-bold">{{ getEmployeeName(req.empId) }}</span>
                                                </div>
                                            </td>
                                            <td class="p-4">{{ req.type }}</td>
                                            <td class="p-4">
                                                <div class="flex flex-col">
                                                    <span class="font-bold">{{ req.days }} Days</span>
                                                    <span class="text-[10px] text-gray-400">{{ new Date(req.start).toLocaleDateString() }} - {{ new Date(req.end).toLocaleDateString() }}</span>
                                                </div>
                                            </td>
                                            <td class="p-4 max-w-xs truncate" :title="req.reason || req.customReason">
                                                {{ req.customReason || req.reason || 'No specific reason' }}
                                            </td>
                                            <td class="p-4">
                                                <span class="text-xs font-bold px-3 py-1 rounded-full" :class="statusClass(req.status)">{{ req.status }}</span>
                                            </td>
                                            <td class="p-4">
                                                <div v-if="req.status === 'Pending'" class="flex gap-2">
                                                    <button @click="handleLeaveAction(req.id, 'Approved')" class="bg-[#05CD99] hover:bg-emerald-600 text-white w-8 h-8 rounded-lg flex items-center justify-center" title="Approve"><i class="fa-solid fa-check"></i></button>
                                                    <button @click="handleLeaveAction(req.id, 'Denied')" class="bg-[#EE5D50] hover:bg-red-600 text-white w-8 h-8 rounded-lg flex items-center justify-center" title="Deny"><i class="fa-solid fa-xmark"></i></button>
                                                </div>
                                                <div v-else class="text-xs text-gray-400 italic">No actions</div>
                                            </td>
                                        </tr>
                                        <tr v-if="allLeaveRequests.length === 0">
                                            <td colspan="6" class="p-8 text-center text-gray-400">No pending leave requests found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-else>
                        <h2 class="text-2xl font-bold text-[#2B3674] mb-6">Request Time Off</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-[20px] shadow-sm">
                                <form @submit.prevent="submitLeave" class="space-y-5">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-xs font-bold text-[#A3AED0] mb-1 block">Start</label><input v-model="leaveForm.start" type="date" class="w-full p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-[#2B3674] focus:outline-none"></div>
                                        <div><label class="text-xs font-bold text-[#A3AED0] mb-1 block">End</label><input v-model="leaveForm.end" type="date" class="w-full p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-[#2B3674] focus:outline-none"></div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-[#A3AED0] mb-1 block">Type</label>
                                        <select v-model="leaveForm.type" class="w-full p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-[#2B3674] focus:outline-none">
                                            <option>Annual Leave</option>
                                            <option>Sick Leave</option>
                                            <option>Maternity Leave</option>
                                            <option>Unpaid Leave</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    
                                    <div v-if="leaveForm.type === 'Other'" class="animate-[fadeIn_0.3s_ease-out]">
                                        <label class="text-xs font-bold text-[#4318FF] mb-1 block">Specify Reason for 'Other'</label>
                                        <input v-model="leaveForm.customReason" type="text" placeholder="Please specify..." class="w-full p-3 bg-indigo-50 border border-indigo-100 rounded-xl text-sm font-bold text-[#2B3674] focus:outline-none focus:ring-2 focus:ring-[#4318FF]">
                                    </div>

                                    <div><label class="text-xs font-bold text-[#A3AED0] mb-1 block">Notes (Optional)</label><textarea v-model="leaveForm.reason" rows="2" class="w-full p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-[#2B3674] focus:outline-none resize-none"></textarea></div>
                                    <div v-if="calculatedDays > 0" class="bg-[#F4F7FE] p-3 rounded-xl flex justify-between items-center text-sm font-bold text-[#4318FF]"><span>Duration:</span><span>{{ calculatedDays }} Days</span></div>
                                    <button type="submit" :disabled="calculatedDays <= 0" class="w-full bg-[#4318FF] text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 transition-colors">Submit Request</button>
                                </form>
                            </div>
                            <div class="bg-white p-6 rounded-[20px] shadow-sm">
                                <h3 class="font-bold text-[#2B3674] mb-4">History</h3>
                                <div class="space-y-3">
                                    <div v-for="req in leaveHistory" :key="req.id" class="flex justify-between items-center p-3 rounded-xl bg-[#F4F7FE]">
                                        <div>
                                            <p class="text-sm font-bold text-[#2B3674]">{{ req.type }} <span v-if="req.type==='Other'" class="text-[10px] text-gray-500">({{ req.customReason }})</span></p>
                                            <p class="text-xs text-[#A3AED0]">{{ req.days }} Days ‚Ä¢ {{ new Date(req.start).toLocaleDateString() }}</p>
                                        </div>
                                        <span class="text-xs font-bold px-3 py-1 rounded-full" :class="statusClass(req.status)">{{ req.status }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'tickets'" class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-[#2B3674] mb-6">IT & HR Help Desk</h2>
                    
                    <div v-if="currentUser.role === 'HR Admin'" class="bg-white p-6 rounded-[20px] shadow-sm">
                        <h3 class="font-bold text-[#2B3674] mb-4">All Tickets (Board View)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-xs text-[#A3AED0] border-b border-gray-100"><th class="p-3">ID</th><th class="p-3">Employee</th><th class="p-3">Category</th><th class="p-3">Description</th><th class="p-3">Priority</th><th class="p-3">Action</th></tr>
                                </thead>
                                <tbody class="text-sm text-[#2B3674]">
                                    <tr v-for="t in allTickets" :key="t.id" class="border-b border-gray-50 hover:bg-[#F4F7FE]">
                                        <td class="p-3 font-bold">#{{ t.id }}</td>
                                        <td class="p-3">{{ getEmployeeName(t.empId) }}</td>
                                        <td class="p-3"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">{{ t.category }}</span></td>
                                        <td class="p-3 max-w-xs truncate">{{ t.description }}</td>
                                        <td class="p-3"><span :class="priorityClass(t.priority)" class="px-2 py-1 rounded text-xs font-bold">{{ t.priority }}</span></td>
                                        <td class="p-3">
                                            <button v-if="t.status === 'Open'" @click="resolveTicket(t.id)" class="bg-[#05CD99] text-white px-3 py-1 rounded text-xs">Close</button>
                                            <span v-else class="text-[#05CD99] font-bold"><i class="fa-solid fa-check"></i> Done</span>
                                        </td>
                                    </tr>
                                    <tr v-if="allTickets.length === 0"><td colspan="6" class="p-4 text-center text-gray-400">No tickets raised.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-[20px] shadow-sm">
                            <h3 class="font-bold text-[#2B3674] mb-4">Raise a Ticket</h3>
                            <form @submit.prevent="submitTicket" class="space-y-4">
                                <div><label class="text-xs font-bold text-[#A3AED0]">Category</label>
                                <select v-model="ticketForm.category" class="w-full mt-1 p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold"><option>IT Hardware</option><option>Software/Access</option><option>Payroll</option><option>Workplace Issue</option></select></div>
                                <div><label class="text-xs font-bold text-[#A3AED0]">Priority</label>
                                <select v-model="ticketForm.priority" class="w-full mt-1 p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold"><option>Low</option><option>Medium</option><option>High</option><option>Critical</option></select></div>
                                <div><label class="text-xs font-bold text-[#A3AED0]">Description</label>
                                <textarea v-model="ticketForm.description" rows="4" class="w-full mt-1 p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold resize-none" placeholder="Describe the issue..."></textarea></div>
                                <button type="submit" class="w-full bg-[#4318FF] text-white font-bold py-3 rounded-xl hover:bg-indigo-700">Raise Ticket</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-[20px] shadow-sm">
                            <h3 class="font-bold text-[#2B3674] mb-4">My Tickets</h3>
                            <div class="space-y-3">
                                <div v-for="t in myTickets" :key="t.id" class="p-4 rounded-xl border border-gray-100 flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1"><span class="font-bold text-sm text-[#2B3674]">{{ t.category }}</span> <span :class="priorityClass(t.priority)" class="text-[10px] px-2 py-0.5 rounded">{{ t.priority }}</span></div>
                                        <p class="text-sm text-gray-600">{{ t.description }}</p>
                                        <p class="text-[10px] text-gray-400 mt-2">{{ new Date(t.date).toLocaleString() }}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold" :class="t.status === 'Open' ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600'">{{ t.status }}</span>
                                </div>
                                <div v-if="myTickets.length === 0" class="text-center text-gray-400 py-10">No tickets yet.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'team'" class="h-[calc(100vh-140px)] flex gap-6 max-w-7xl mx-auto">
                    <div class="flex-1 flex flex-col gap-6 h-full">
                        <div class="flex-1 bg-white rounded-[20px] shadow-sm flex flex-col overflow-hidden">
                            <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                <h3 class="font-bold text-[#2B3674]"><i class="fa-solid fa-comments text-[#4318FF] mr-2"></i> General Channel</h3>
                                <span class="text-xs text-green-500 font-bold flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Live</span>
                            </div>
                            <div id="groupChatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#F4F7FE]">
                                <div v-for="msg in groupMessages" :key="msg.id" class="flex gap-3" :class="msg.empId === currentUser.id ? 'flex-row-reverse' : ''">
                                    <div class="w-8 h-8 rounded-full bg-white border flex items-center justify-center font-bold text-xs shadow-sm">{{ getInitials(msg.empId) }}</div>
                                    <div class="max-w-[70%]">
                                        <div class="flex items-end gap-2 mb-1" :class="msg.empId === currentUser.id ? 'flex-row-reverse' : ''">
                                            <span class="text-[10px] font-bold text-gray-500">{{ getEmployeeName(msg.empId) }}</span>
                                            <span class="text-[8px] text-gray-400">{{ new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }}</span>
                                        </div>
                                        <div class="p-3 rounded-2xl text-sm shadow-sm" :class="msg.empId === currentUser.id ? 'bg-[#4318FF] text-white rounded-tr-sm' : 'bg-white text-[#2B3674] rounded-tl-sm'">{{ msg.message }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-white">
                                <form @submit.prevent="sendGroupMessage" class="flex gap-2">
                                    <input v-model="groupChatInput" type="text" placeholder="Message the team..." class="flex-1 bg-[#F4F7FE] rounded-xl px-4 py-3 outline-none focus:ring-1 focus:ring-[#4318FF]">
                                    <button type="submit" class="bg-[#4318FF] text-white w-12 rounded-xl hover:bg-indigo-700"><i class="fa-solid fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </div>
                        
                        <div class="h-48 bg-white rounded-[20px] shadow-sm flex flex-col overflow-hidden">
                            <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                <h3 class="font-bold text-[#2B3674] text-sm"><i class="fa-solid fa-file-pen text-[#FFB547] mr-2"></i> Meeting Minutes (Shared)</h3>
                                <button @click="saveMeetingNotes" class="text-xs bg-[#4318FF] text-white px-3 py-1 rounded-lg">Save Notes</button>
                            </div>
                            <textarea v-model="meetingNotes" class="flex-1 p-4 bg-white resize-none outline-none text-sm text-[#2B3674]" placeholder="Type meeting notes here... (Visible to everyone)"></textarea>
                        </div>
                    </div>

                    <div class="w-80 bg-white rounded-[20px] shadow-sm flex flex-col p-6 text-center">
                        <h3 class="font-bold text-[#2B3674] mb-2">Team Huddle</h3>
                        <p class="text-xs text-[#A3AED0] mb-6">Daily Standup Room</p>
                        
                        <div class="w-32 h-32 mx-auto bg-indigo-50 rounded-full flex items-center justify-center mb-6 relative">
                            <i class="fa-solid fa-microphone-lines text-4xl text-[#4318FF]"></i>
                            <div class="absolute inset-0 rounded-full border-4 border-[#4318FF] opacity-20 animate-ping"></div>
                        </div>

                        <div v-if="inCall" class="space-y-4">
                            <div class="text-[#05CD99] font-bold text-sm">‚óè Connected ({{ callTimerFormatted }})</div>
                            <div class="flex justify-center gap-4">
                                <button class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600"><i class="fa-solid fa-microphone-slash"></i></button>
                                <button class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600"><i class="fa-solid fa-video-slash"></i></button>
                                <button @click="endCall" class="w-10 h-10 rounded-full bg-red-500 hover:bg-red-600 text-white"><i class="fa-solid fa-phone-slash"></i></button>
                            </div>
                        </div>
                        <div v-else class="space-y-3">
                             <button v-if="currentUser.role === 'HR Admin'" @click="startCall" class="w-full bg-[#4318FF] hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg">
                                <i class="fa-solid fa-phone-volume mr-2"></i> Start Call
                            </button>
                            <button @click="joinCall" class="w-full bg-[#05CD99] hover:bg-emerald-600 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-emerald-500/30">
                                <i class="fa-solid fa-phone mr-2"></i> Join Audio
                            </button>
                            <p class="text-[10px] text-gray-400 mt-3">3 members currently in call</p>
                        </div>

                        <div class="mt-auto pt-6 border-t border-gray-100">
                            <p class="text-xs font-bold text-left text-[#A3AED0] mb-3 uppercase">Online Team</p>
                            <div class="flex -space-x-2 overflow-hidden">
                                <div v-for="emp in allEmployees.slice(0,5)" :key="emp.id" class="inline-block h-8 w-8 rounded-full ring-2 ring-white bg-[#F4F7FE] flex items-center justify-center text-xs font-bold text-[#4318FF] cursor-pointer" :title="emp.name">
                                    {{ emp.name.charAt(0) }}
                                </div>
                                <div class="inline-block h-8 w-8 rounded-full ring-2 ring-white bg-gray-100 flex items-center justify-center text-[10px] text-gray-500 font-bold">+{{ allEmployees.length }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'docs'" class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-[#2B3674] mb-6">Document Management</h2>
                    
                    <div v-if="currentUser.role === 'HR Admin'" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-[20px] shadow-sm h-fit">
                            <h3 class="font-bold text-[#2B3674] mb-4">Upload Document</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-[#A3AED0]">Assign To</label>
                                    <select v-model="docForm.empId" class="w-full mt-1 p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold">
                                        <option value="" disabled>Select Employee</option>
                                        <option v-for="emp in allEmployees" :key="emp.id" :value="emp.id">{{ emp.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-[#A3AED0]">Document Title</label>
                                    <input v-model="docForm.title" type="text" placeholder="e.g. Offer Letter" class="w-full mt-1 p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-[#A3AED0]">File</label>
                                    <div class="w-full mt-1 p-3 bg-[#F4F7FE] rounded-xl flex items-center gap-2 relative overflow-hidden">
                                        <input type="file" @change="handleDocUpload" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                                        <div class="bg-white p-2 rounded text-[#4318FF]"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                                        <span class="text-xs font-medium text-gray-500 truncate">{{ docForm.fileName || 'Choose File...' }}</span>
                                    </div>
                                </div>
                                <button @click="saveDocument" class="w-full bg-[#4318FF] text-white font-bold py-3 rounded-xl hover:bg-indigo-700">Upload & Assign</button>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-2 bg-white p-6 rounded-[20px] shadow-sm">
                            <h3 class="font-bold text-[#2B3674] mb-4">All Documents</h3>
                            <div class="space-y-3">
                                <div v-for="doc in docsList" :key="doc.id" class="flex justify-between items-center p-3 rounded-xl border border-gray-100 hover:bg-[#F4F7FE] transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center text-red-500 text-lg"><i class="fa-solid fa-file-pdf"></i></div>
                                        <div>
                                            <p class="text-sm font-bold text-[#2B3674]">{{ doc.title }}</p>
                                            <p class="text-xs text-gray-400">Assigned to: <span class="text-[#4318FF]">{{ getEmployeeName(doc.empId) }}</span></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <a :href="doc.fileData" :download="doc.title" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-[#4318FF] hover:text-white transition-all"><i class="fa-solid fa-download text-xs"></i></a>
                                        <button @click="deleteDocument(doc.id)" class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                <div v-if="docsList.length === 0" class="text-center text-gray-400 py-10">No documents uploaded.</div>
                            </div>
                        </div>
                    </div>

                    <div v-else>
                         <div class="bg-white p-6 rounded-[20px] shadow-sm min-h-[400px]">
                            <h3 class="font-bold text-[#2B3674] mb-6">My Documents</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div v-for="doc in docsList" :key="doc.id" class="border border-gray-200 rounded-xl p-5 hover:shadow-md transition-shadow relative group">
                                    <div class="absolute top-4 right-4 text-gray-300"><i class="fa-solid fa-file text-4xl opacity-20"></i></div>
                                    <div class="w-12 h-12 rounded-lg bg-[#E6FDF5] flex items-center justify-center text-[#05CD99] text-xl mb-4"><i class="fa-solid fa-file-lines"></i></div>
                                    <h4 class="font-bold text-[#2B3674] mb-1 truncate">{{ doc.title }}</h4>
                                    <p class="text-xs text-gray-400 mb-4">{{ new Date(doc.date).toLocaleDateString() }}</p>
                                    <a :href="doc.fileData" :download="doc.title" class="block w-full text-center bg-[#F4F7FE] text-[#4318FF] font-bold py-2 rounded-lg text-sm hover:bg-[#4318FF] hover:text-white transition-colors">Download</a>
                                </div>
                                <div v-if="docsList.length === 0" class="col-span-full text-center text-gray-400 py-20 flex flex-col items-center">
                                    <i class="fa-regular fa-folder-open text-4xl mb-3 opacity-30"></i>
                                    <p>No documents found.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'goals'" class="max-w-5xl mx-auto">
                    <div v-if="currentUser.role === 'HR Admin'">
                        <h2 class="text-2xl font-bold text-[#2B3674] mb-6">Assign Goals</h2>
                        
                        <div class="bg-white p-6 rounded-[20px] shadow-sm mb-4">
                            <h3 class="font-bold text-[#2B3674] mb-4">Mass Assignment</h3>
                            <div class="flex gap-4">
                                <div class="flex-1 p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-gray-500">All Employees</div>
                                <input v-model="massGoalText" type="text" placeholder="Goal Description for Everyone..." class="flex-[2] p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-[#2B3674]">
                                <button @click="assignGoalToAll" class="bg-[#4318FF] text-white font-bold px-6 rounded-xl">Assign All</button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-[20px] shadow-sm mb-8">
                            <h3 class="font-bold text-[#2B3674] mb-4">Individual Assignment</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <select v-model="hrGoalForm.empId" class="p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-[#2B3674]">
                                    <option value="" disabled>Select Employee</option>
                                    <option v-for="emp in allEmployees" :key="emp.id" :value="emp.id">{{ emp.name }}</option>
                                </select>
                                <input v-model="hrGoalForm.text" type="text" placeholder="Goal Description..." class="p-3 bg-[#F4F7FE] rounded-xl text-sm font-bold text-[#2B3674]">
                                <button @click="assignGoalToEmployee" class="bg-[#4318FF] text-white font-bold py-3 rounded-xl">Assign</button>
                            </div>
                        </div>
                    </div>

                    <div v-else>
                        <h2 class="text-2xl font-bold text-[#2B3674] mb-6">Onboarding & Goals</h2>
                        
                        <div class="bg-indigo-50 p-6 rounded-[20px] shadow-sm border border-indigo-100 mb-8">
                            <h3 class="font-bold text-[#4318FF] mb-4 text-lg flex items-center gap-2"><i class="fa-solid fa-user-shield"></i> Assigned by HR</h3>
                            <div v-if="assignedGoals.length === 0" class="text-sm text-gray-400">No tasks assigned yet.</div>
                            <div class="space-y-3">
                                <div v-for="goal in assignedGoals" :key="goal.id" class="flex items-center gap-3 bg-white p-3 rounded-lg">
                                    <input type="checkbox" v-model="goal.isCompleted" @change="updateAssignedGoal(goal)" class="w-5 h-5 text-[#4318FF] rounded">
                                    <div>
                                        <p :class="goal.isCompleted ? 'text-gray-400 line-through' : 'text-[#2B3674]'" class="text-sm font-medium">{{ goal.text }}</p>
                                        <p class="text-[10px] text-gray-400">Assigned: {{ new Date(goal.date).toLocaleDateString() }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-[20px] shadow-sm border-t-4 border-[#4318FF]">
                                <h3 class="font-bold text-[#2B3674] mb-4 text-lg">First Day Goals</h3>
                                <div class="space-y-3 mb-4">
                                    <div v-for="(goal, idx) in myGoals.day" :key="idx" class="flex items-center gap-3">
                                        <input type="checkbox" v-model="goal.done" @change="saveGoals" class="w-5 h-5 text-[#4318FF] rounded">
                                        <span :class="goal.done ? 'text-gray-400 line-through' : 'text-[#2B3674]'" class="text-sm font-medium">{{ goal.text }}</span>
                                    </div>
                                </div>
                                <div class="flex gap-1 mt-2">
                                    <input v-model="newGoalInput.day" placeholder="Add task..." class="flex-1 text-xs bg-[#F4F7FE] p-2 rounded-lg">
                                    <button @click="addPersonalGoal('day')" class="text-[#4318FF] font-bold px-2">+</button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-[20px] shadow-sm border-t-4 border-[#05CD99]">
                                <h3 class="font-bold text-[#2B3674] mb-4 text-lg">First Week Goals</h3>
                                <div class="space-y-3 mb-4">
                                    <div v-for="(goal, idx) in myGoals.week" :key="idx" class="flex items-center gap-3">
                                        <input type="checkbox" v-model="goal.done" @change="saveGoals" class="w-5 h-5 text-[#05CD99] rounded">
                                        <span :class="goal.done ? 'text-gray-400 line-through' : 'text-[#2B3674]'" class="text-sm font-medium">{{ goal.text }}</span>
                                    </div>
                                </div>
                                <div class="flex gap-1 mt-2">
                                    <input v-model="newGoalInput.week" placeholder="Add task..." class="flex-1 text-xs bg-[#F4F7FE] p-2 rounded-lg">
                                    <button @click="addPersonalGoal('week')" class="text-[#05CD99] font-bold px-2">+</button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-[20px] shadow-sm border-t-4 border-[#FFB547]">
                                <h3 class="font-bold text-[#2B3674] mb-4 text-lg">First Month Goals</h3>
                                <div class="space-y-3 mb-4">
                                    <div v-for="(goal, idx) in myGoals.month" :key="idx" class="flex items-center gap-3">
                                        <input type="checkbox" v-model="goal.done" @change="saveGoals" class="w-5 h-5 text-[#FFB547] rounded">
                                        <span :class="goal.done ? 'text-gray-400 line-through' : 'text-[#2B3674]'" class="text-sm font-medium">{{ goal.text }}</span>
                                    </div>
                                </div>
                                <div class="flex gap-1 mt-2">
                                    <input v-model="newGoalInput.month" placeholder="Add task..." class="flex-1 text-xs bg-[#F4F7FE] p-2 rounded-lg">
                                    <button @click="addPersonalGoal('month')" class="text-[#FFB547] font-bold px-2">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'profile'" class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div class="bg-white rounded-[20px] p-8 text-center shadow-sm relative overflow-hidden mt-10 h-fit">
                        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-[#868CFF] to-[#4318FF]"></div>
                        <div class="relative z-10 w-28 h-28 bg-white rounded-full mx-auto -mt-12 p-1 shadow-lg group cursor-pointer" @click="triggerFileInput">
                            <div class="w-full h-full bg-[#F4F7FE] rounded-full flex items-center justify-center overflow-hidden relative">
                                <img v-if="currentUser.photo" :src="currentUser.photo" class="w-full h-full object-cover">
                                <div v-else class="text-[#4318FF] text-3xl font-bold">{{ currentUser.name.charAt(0) }}</div>
                            </div>
                            <input type="file" ref="fileInput" @change="handlePhotoUpload" class="hidden" accept="image/*">
                        </div>
                        <h2 class="text-2xl font-bold text-[#2B3674] mt-4">{{ currentUser.name }}</h2>
                        <p class="text-[#A3AED0] font-medium">{{ currentUser.role }}</p>

                        <div class="mt-8 text-left space-y-4">
                            <div class="flex justify-between border-b border-gray-100 pb-2">
                                <span class="text-xs font-bold text-[#A3AED0] uppercase">Employee ID</span>
                                <span class="text-sm font-bold text-[#2B3674]">{{ currentUser.id.toUpperCase() }}</span>
                            </div>
                            
                            <div v-if="!isEditingProfile">
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-xs font-bold text-[#A3AED0] uppercase">Date of Joining</span>
                                    <span class="text-sm font-bold text-[#2B3674]">{{ currentUser.joiningDate || 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-xs font-bold text-[#A3AED0] uppercase">Email</span>
                                    <span class="text-sm font-bold text-[#2B3674]">{{ currentUser.email }}</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-xs font-bold text-[#A3AED0] uppercase">Phone</span>
                                    <span class="text-sm font-bold text-[#2B3674]">{{ currentUser.phone || 'N/A' }}</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-100 pb-2">
                                    <span class="text-xs font-bold text-[#A3AED0] uppercase">Qualification</span>
                                    <span class="text-sm font-bold text-[#2B3674]">{{ currentUser.education || 'N/A' }}</span>
                                </div>
                                <button @click="toggleEditProfile" class="mt-4 w-full bg-[#F4F7FE] text-[#4318FF] font-bold py-2 rounded-xl text-sm">Edit Profile</button>
                            </div>

                            <div v-else class="space-y-3">
                                <div><label class="text-xs text-[#A3AED0]">Date of Joining</label><input v-model="editProfileForm.joiningDate" type="date" class="w-full bg-[#F4F7FE] p-2 rounded text-sm"></div>
                                <div><label class="text-xs text-[#A3AED0]">Email</label><input v-model="editProfileForm.email" type="email" class="w-full bg-[#F4F7FE] p-2 rounded text-sm"></div>
                                <div><label class="text-xs text-[#A3AED0]">Phone</label><input v-model="editProfileForm.phone" type="text" class="w-full bg-[#F4F7FE] p-2 rounded text-sm"></div>
                                <div><label class="text-xs text-[#A3AED0]">Qualification</label><input v-model="editProfileForm.education" type="text" class="w-full bg-[#F4F7FE] p-2 rounded text-sm"></div>
                                <div class="flex gap-2">
                                    <button @click="saveProfile" class="flex-1 bg-[#4318FF] text-white font-bold py-2 rounded-xl text-sm">Save</button>
                                    <button @click="isEditingProfile = false" class="flex-1 bg-gray-200 text-gray-600 font-bold py-2 rounded-xl text-sm">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6 mt-10 lg:mt-0">
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-[20px] shadow-lg border border-slate-700 overflow-hidden text-white relative h-fit">
                            <div class="absolute top-0 right-0 p-8 opacity-10 text-white"><i class="fa-solid fa-chess-knight text-9xl"></i></div>
                            <div class="p-8 relative z-10">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
                                        <i class="fa-solid fa-wand-magic-sparkles text-yellow-400 text-lg"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-lg">Gemini Career Coach</h3>
                                        <p class="text-xs text-slate-400">Personalized for {{ currentUser.role }}</p>
                                    </div>
                                </div>
                                <p class="text-slate-300 text-sm mb-6 leading-relaxed">Get personalized growth tips and actionable advice based on your specific role and company tenure.</p>
                                
                                <button v-if="!careerAdvice" @click="getCareerAdvice" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-3 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-lightbulb" :class="{'animate-bounce': isAdvising}"></i>
                                    {{ isAdvising ? 'Analyzing Profile...' : 'Get Career Tips' }}
                                </button>
                                
                                <div v-if="careerAdvice" class="mt-4 bg-white/5 p-5 rounded-xl border border-white/10 text-sm prose prose-invert prose-sm max-w-none">
                                    <div v-html="parseMarkdown(careerAdvice)"></div>
                                    <button @click="getCareerAdvice" class="mt-4 text-xs text-indigo-300 hover:text-white underline font-bold">Refresh Advice</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <transition name="fade">
            <div v-if="isChatOpen" class="fixed inset-0 z-50 flex items-center justify-center md:items-end md:justify-end md:p-6 bg-[#111C44]/50 backdrop-blur-sm">
                <div class="bg-white w-full h-full md:w-[400px] md:h-[600px] md:rounded-[20px] shadow-2xl flex flex-col overflow-hidden relative">
                    <div class="bg-[#4318FF] p-4 flex justify-between items-center text-white">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fa-solid fa-robot"></i></div><div><h3 class="font-bold text-sm">Gemini Assistant</h3><p class="text-[10px] text-indigo-100">Powered by Nexus HR Policy</p></div></div>
                        <button @click="toggleChat" class="w-8 h-8 flex items-center justify-center hover:bg-white/20 rounded-full transition-all"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#F4F7FE] custom-scroll">
                        <div v-for="(msg, i) in chatMessages" :key="i" class="flex gap-3" :class="msg.isUser ? 'flex-row-reverse' : ''">
                            <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold shadow-sm" :class="msg.isUser ? 'bg-[#4318FF] text-white' : 'bg-white text-[#4318FF]'">{{ msg.isUser ? 'U' : 'AI' }}</div>
                            <div class="max-w-[80%] p-3 rounded-2xl text-sm shadow-sm prose prose-sm" :class="msg.isUser ? 'bg-[#4318FF] text-white rounded-tr-sm' : 'bg-white text-[#2B3674] rounded-tl-sm'" v-html="msg.isUser ? msg.text : parseMarkdown(msg.text)"></div>
                        </div>
                        <div v-if="isTyping" class="flex gap-2 text-[#A3AED0] text-xs font-bold items-center ml-12"><i class="fa-solid fa-circle-notch fa-spin"></i> Gemini is thinking...</div>
                    </div>
                    <div class="p-4 bg-white border-t border-slate-100">
                        <form @submit.prevent="sendMessage" class="flex gap-2">
                            <input v-model="chatInput" type="text" placeholder="Ask about policies..." class="flex-1 bg-[#F4F7FE] rounded-xl px-4 py-3 text-sm font-medium text-[#2B3674] focus:outline-none focus:ring-2 focus:ring-[#4318FF]">
                            <button type="submit" class="w-12 h-12 bg-[#4318FF] rounded-xl text-white flex items-center justify-center hover:bg-indigo-700 transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script type="module">
        import { createApp, ref, computed, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, 
            query, where, orderBy, onSnapshot, limit, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC94Wt8ifGVDitNm5BJbq1kKnc4PA3IYEs",
            authDomain: "nexushr-92bfa.firebaseapp.com",
            projectId: "nexushr-92bfa",
            storageBucket: "nexushr-92bfa.firebasestorage.app",
            messagingSenderId: "1033302689842",
            appId: "1:1033302689842:web:e06ef7487fd0f760fa142b",
            measurementId: "G-EQ94S7GNYB"
        };
        // ---------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- ‚ö†Ô∏è REPLACE THIS WITH YOUR NEW KEY FROM GOOGLE AI STUDIO ---
        //const GEMINI_API_KEY = 'AIzaSyAL10WixOvu4oYgKcZH9waDLZHl1CUl0iw';

        createApp({
            setup() {
                // --- STATE VARIABLES (Same as before) ---
                const currentUser = ref(null);
                const activeTab = ref('home');
                const activeLoginPortal = ref('employee');
                const loginForm = ref({ id: '', password: '' });
                const employeesMap = ref({});
                const allEmployees = ref([]);
                const currentTimeIST = ref("");
                const showPasswordPrompt = ref(false);
                const pendingLoginUser = ref(null);
                const isChatOpen = ref(false);
                const chatInput = ref("");
                const chatMessages = ref([{ isUser: false, text: "Hello! I am Nexus AI. Ask me about **Leave Policy** or **Holidays**." }]);
                const isTyping = ref(false);
                const careerAdvice = ref("");
                const isAdvising = ref(false);
                const leaveForm = ref({ start: "", end: "", type: "Annual Leave", reason: "", customReason: "" });
                const leaveHistory = ref([]);
                const allLeaveRequests = ref([]);
                const ticketForm = ref({ category: "IT Hardware", priority: "Medium", description: "" });
                const myTickets = ref([]);
                const allTickets = ref([]);
                const groupChatInput = ref("");
                const groupMessages = ref([]);
                const inCall = ref(false);
                const callStartTime = ref(null);
                const callTimerFormatted = ref("00:00");
                const meetingNotes = ref("");
                const myTasks = ref([]);
                const newTaskText = ref("");
                const myGoals = ref({ day: [], week: [], month: [] });
                const assignedGoals = ref([]);
                const hrGoalForm = ref({ empId: "", text: "" });
                const newGoalInput = ref({ day: "", week: "", month: "" });
                const massGoalText = ref("");
                const allEmployeeStats = ref([]);
                const isEditingProfile = ref(false);
                const editProfileForm = ref({});
                const isSystemInCall = ref(false);
                const showNotification = ref(false);
                const notificationMessage = ref("");
                const notificationType = ref("");
                const docsList = ref([]);
                const docForm = ref({ empId: "", title: "", fileData: null, fileName: "" });

                // --- COMPUTED (Same as before) ---
                const calculatedDays = computed(() => {
                    if(!leaveForm.value.start || !leaveForm.value.end) return 0;
                    const diff = new Date(leaveForm.value.end) - new Date(leaveForm.value.start);
                    return diff > 0 ? Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1 : 0;
                });
                
                const calculateMyPerformance = computed(() => {
                    if(assignedGoals.value.length === 0) return 0;
                    const completed = assignedGoals.value.filter(g => g.isCompleted).length;
                    return Math.round((completed / assignedGoals.value.length) * 100);
                });

                const navClass = (tab) => activeTab.value === tab ? 'bg-[#4318FF] text-white shadow-md' : 'text-[#A3AED0] hover:text-[#4318FF]';
                const priorityClass = (p) => {
                    if(p === 'Critical' || p === 'High') return 'bg-red-100 text-red-600';
                    if(p === 'Medium') return 'bg-orange-100 text-orange-600';
                    return 'bg-green-100 text-green-600';
                }
                 const statusClass = (s) => {
                    if(s === 'Approved') return 'bg-[#05CD99]/10 text-[#05CD99]';
                    if(s === 'Denied') return 'bg-[#EE5D50]/10 text-[#EE5D50]';
                    return 'bg-[#FFB547]/10 text-[#FFB547]'; // Pending
                };
                const statusColorClass = (s) => {
                    if(s === 'Busy') return 'bg-[#EE5D50]'; 
                    if(s === 'DND') return 'bg-[#FFB547]'; 
                    return 'bg-[#05CD99]';
                }

                // --- CORE LOGIC ---

                // 1. Initialize DB with Default Users if Empty
                const initDB = async () => {
                    const snapshot = await getDocs(collection(db, "employees"));
                    if (snapshot.empty) {
                        const defaultUsers = [
                            { id: 'emp01', name: 'Lakshaya', password: '12345', role: 'Senior Developer', leaveBalance: 18, email: 'lakshaya@nexus.hr', tasks: [], status: 'Online', joiningDate: '2022-05-10', education: 'M.Sc Computer Science' },
                            { id: 'hr01', name: 'Admin User', password: '12345', role: 'HR Admin', leaveBalance: 25, email: 'admin@nexus.hr', status: 'Online', joiningDate: '2020-01-01' },
                            { id: 'emp02', name: 'Sarah Smith', password: '12345', role: 'Designer', leaveBalance: 12, status: 'Busy', joiningDate: '2023-08-20' },
                            { id: 'emp03', name: 'Tanisha', password: '12345', role: 'Product Manager', leaveBalance: 15, email: 'tanisha@nexus.hr', tasks: [], status: 'Online', joiningDate: '2023-11-01', education: 'MBA' }
                        ];
                        for (const u of defaultUsers) {
                            await setDoc(doc(db, "employees", u.id), u);
                        }
                        console.log("Database initialized.");
                    }
                };
                initDB();

                const checkSavedPass = () => {
                    if(loginForm.value.id) {
                        const saved = localStorage.getItem(`nexus_pass_${loginForm.value.id}`);
                        if(saved) loginForm.value.password = saved;
                    }
                };
                setInterval(() => { if(!currentUser.value && loginForm.value.id && !loginForm.value.password) checkSavedPass(); }, 500);

                const login = async () => {
                    try {
                        const docRef = doc(db, "employees", loginForm.value.id);
                        const docSnap = await getDoc(docRef);
                        
                        if(docSnap.exists()) {
                            const user = docSnap.data();
                            if(activeLoginPortal.value === 'hr' && user.role !== 'HR Admin') { alert("Access Denied"); return; }
                            if(loginForm.value.password !== user.password) { alert("Incorrect Password"); return; }

                            const savedPass = localStorage.getItem(`nexus_pass_${user.id}`);
                            if(savedPass) {
                                finishLogin(user);
                            } else {
                                pendingLoginUser.value = user;
                                showPasswordPrompt.value = true;
                            }
                        } else {
                            alert("User not found (Try emp01, hr01 or emp03)");
                        }
                    } catch (e) { console.error(e); alert("Login Error: Check Console"); }
                };

                const handleSavePassword = (save) => {
                    if(save && pendingLoginUser.value) {
                        localStorage.setItem(`nexus_pass_${pendingLoginUser.value.id}`, loginForm.value.password);
                    }
                    showPasswordPrompt.value = false;
                    finishLogin(pendingLoginUser.value);
                    pendingLoginUser.value = null;
                };

                const finishLogin = async (user) => {
                    // Normalize data
                    if(!user.goals) {
                        user.goals = {
                            day: [{text: 'Setup Email', done: false}, {text: 'Meet the Team', done: false}],
                            week: [{text: 'Complete HR Training', done: false}, {text: 'Configure Dev Environment', done: false}],
                            month: [{text: 'First Project Commit', done: false}, {text: '1-on-1 with Manager', done: false}]
                        };
                    }
                    currentUser.value = user;
                    setupRealtimeListeners(); // START REALTIME SYNC
                    updateClock();
                    setInterval(updateClock, 1000);
                };

                const updateClock = () => {
                    currentTimeIST.value = new Date().toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit' });
                };

                const logout = () => {
                    if(inCall.value && currentUser.value.role === 'HR Admin') endCall();
                    currentUser.value = null;
                    loginForm.value.id = '';
                    loginForm.value.password = '';
                    activeTab.value = 'home';
                    // Reload to clear listeners is simplest way to avoid memory leaks in this simple structure
                    window.location.reload(); 
                };

                // --- FIREBASE REALTIME LISTENERS ---
                const setupRealtimeListeners = () => {
                    // 1. Listen to Current User Updates
                    onSnapshot(doc(db, "employees", currentUser.value.id), (doc) => {
                        if(doc.exists()) {
                            const data = doc.data();
                            currentUser.value = { ...currentUser.value, ...data };
                            myTasks.value = data.tasks || [];
                            myGoals.value = data.goals || { day: [], week: [], month: [] };
                        }
                    });

                    // 2. Listen to All Employees (for status list)
                    onSnapshot(collection(db, "employees"), (snapshot) => {
                        const emps = [];
                        snapshot.forEach(doc => emps.push({ id: doc.id, ...doc.data() }));
                        allEmployees.value = emps;
                        emps.forEach(e => employeesMap.value[e.id] = e.name);
                        
                        // Update HR Stats if needed
                        if(currentUser.value.role === 'HR Admin') calculateHRStats();
                    });

                    // 3. Listen to System State (Call, Notes)
                    onSnapshot(collection(db, "systemState"), (snapshot) => {
                        snapshot.forEach(d => {
                            if(d.id === 'callActive') isSystemInCall.value = d.data().value;
                            if(d.id === 'callStartTime') callStartTime.value = d.data().value;
                            if(d.id === 'meetingNotes') meetingNotes.value = d.data().value;
                        });
                        
                        // Call Timer Logic
                        if(isSystemInCall.value && callStartTime.value) {
                            const diff = Math.floor((Date.now() - callStartTime.value) / 1000);
                            const m = Math.floor(diff / 60).toString().padStart(2, '0');
                            const s = (diff % 60).toString().padStart(2, '0');
                            callTimerFormatted.value = `${m}:${s}`;
                        } else {
                            callTimerFormatted.value = "00:00";
                        }
                    });

                    // 4. Listen to Group Chat
                    const qChat = query(collection(db, "groupChat"), orderBy("time", "desc"), limit(50));
                    onSnapshot(qChat, (snapshot) => {
                        let msgs = [];
                        snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                        groupMessages.value = msgs.reverse();
                        nextTick(() => { 
                            const el = document.getElementById('groupChatContainer');
                            if(el) el.scrollTop = el.scrollHeight; 
                        });
                    });

                    // 5. Role Specific Listeners
                    if(currentUser.value.role === 'HR Admin') {
                        // Tickets
                        onSnapshot(collection(db, "tickets"), (snap) => {
                            let t = []; snap.forEach(d => t.push({id: d.id, ...d.data()}));
                            allTickets.value = t.sort((a,b) => new Date(b.date) - new Date(a.date));
                        });
                        // Leave Requests
                        onSnapshot(collection(db, "requests"), (snap) => {
                            let r = []; snap.forEach(d => r.push({id: d.id, ...d.data()}));
                            allLeaveRequests.value = r.sort((a,b) => new Date(b.start) - new Date(a.start));
                        });
                        // Docs
                        onSnapshot(collection(db, "employeeDocs"), (snap) => {
                            let d = []; snap.forEach(doc => d.push({id: doc.id, ...doc.data()}));
                            docsList.value = d.sort((a,b) => new Date(b.date) - new Date(a.date));
                        });
                    } else {
                        // My Tickets
                        const qTickets = query(collection(db, "tickets"), where("empId", "==", currentUser.value.id));
                        onSnapshot(qTickets, (snap) => {
                            let t = []; snap.forEach(d => t.push({id: d.id, ...d.data()}));
                            myTickets.value = t.sort((a,b) => new Date(b.date) - new Date(a.date));
                        });
                        // My Requests
                        const qReq = query(collection(db, "requests"), where("empId", "==", currentUser.value.id));
                        onSnapshot(qReq, (snap) => {
                            let r = []; snap.forEach(d => r.push({id: d.id, ...d.data()}));
                            leaveHistory.value = r.sort((a,b) => new Date(b.start) - new Date(a.start));
                        });
                        // My Assigned Goals
                        const qGoals = query(collection(db, "assignedGoals"), where("empId", "==", currentUser.value.id));
                        onSnapshot(qGoals, (snap) => {
                            let g = []; snap.forEach(d => g.push({id: d.id, ...d.data()}));
                            if(g.length > assignedGoals.value.length && assignedGoals.value.length > 0) {
                                showNotification.value = true;
                                notificationMessage.value = "New goal assigned by HR.";
                                notificationType.value = "task";
                            }
                            assignedGoals.value = g.sort((a,b) => new Date(b.date) - new Date(a.date));
                        });
                        // My Docs
                         const qDocs = query(collection(db, "employeeDocs"), where("empId", "==", currentUser.value.id));
                        onSnapshot(qDocs, (snap) => {
                            let d = []; snap.forEach(doc => d.push({id: doc.id, ...doc.data()}));
                            docsList.value = d.sort((a,b) => new Date(b.date) - new Date(a.date));
                        });
                    }
                };

                const calculateHRStats = async () => {
                    // Needs separate query for stats as 'assignedGoals' isn't fully loaded for HR in realtime listener to save bandwidth
                    // Using snapshot for one-time calc
                    const snap = await getDocs(collection(db, "assignedGoals"));
                    const allGoals = [];
                    snap.forEach(d => allGoals.push(d.data()));
                    
                    const stats = [];
                    for(const emp of allEmployees.value) {
                        if(emp.role !== 'HR Admin') {
                            const goals = allGoals.filter(g => g.empId === emp.id);
                            const total = goals.length;
                            const completed = goals.filter(g => g.isCompleted).length;
                            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                            stats.push({ id: emp.id, name: emp.name, role: emp.role, total, completed, percentage });
                        }
                    }
                    allEmployeeStats.value = stats;
                };

                // --- ACTIONS ---

                const saveMeetingNotes = async () => {
                    await setDoc(doc(db, "systemState", "meetingNotes"), { value: meetingNotes.value });
                    alert("Notes Saved to Cloud!");
                };

                const updateStatus = async () => {
                    await updateDoc(doc(db, "employees", currentUser.value.id), { status: currentUser.value.status });
                };

                const saveGoals = async () => {
                    await updateDoc(doc(db, "employees", currentUser.value.id), { goals: myGoals.value });
                };

                const addPersonalGoal = async (type) => {
                    if(!newGoalInput.value[type]) return;
                    myGoals.value[type].push({ text: newGoalInput.value[type], done: false });
                    newGoalInput.value[type] = "";
                    await saveGoals();
                };

                const assignGoalToEmployee = async () => {
                    if(!hrGoalForm.value.empId || !hrGoalForm.value.text) return;
                    await addDoc(collection(db, "assignedGoals"), {
                        empId: hrGoalForm.value.empId,
                        text: hrGoalForm.value.text,
                        isCompleted: false,
                        assignedBy: currentUser.value.name,
                        date: new Date().toISOString()
                    });
                    alert("Goal Assigned"); hrGoalForm.value.text = "";
                };

                const assignGoalToAll = async () => {
                    if(!massGoalText.value) return;
                    const promises = [];
                    for(const emp of allEmployees.value) {
                        if(emp.role !== 'HR Admin') {
                            promises.push(addDoc(collection(db, "assignedGoals"), {
                                empId: emp.id,
                                text: massGoalText.value,
                                isCompleted: false,
                                assignedBy: currentUser.value.name,
                                date: new Date().toISOString()
                            }));
                        }
                    }
                    await Promise.all(promises);
                    alert("Assigned to All"); massGoalText.value = "";
                };

                const updateAssignedGoal = async (goal) => {
                    await updateDoc(doc(db, "assignedGoals", goal.id), { isCompleted: goal.isCompleted });
                };

                // Profile
                const toggleEditProfile = () => { editProfileForm.value = { ...currentUser.value }; isEditingProfile.value = true; };
                const saveProfile = async () => {
                    const { email, phone, joiningDate, education } = editProfileForm.value;
                    await updateDoc(doc(db, "employees", currentUser.value.id), { email, phone, joiningDate, education });
                    isEditingProfile.value = false;
                };

                // Documents
                const handleDocUpload = (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    if(file.size > 800000) { // Limit to 800KB for Firestore safety
                         alert("File too large. Max 800KB allowed for Cloud sync."); return;
                    }
                    docForm.value.fileName = file.name;
                    const reader = new FileReader();
                    reader.onload = (ev) => { docForm.value.fileData = ev.target.result; };
                    reader.readAsDataURL(file);
                };

                const saveDocument = async () => {
                    if(!docForm.value.empId || !docForm.value.title || !docForm.value.fileData) { alert("Incomplete details"); return; }
                    await addDoc(collection(db, "employeeDocs"), {
                        empId: docForm.value.empId,
                        title: docForm.value.title,
                        fileData: docForm.value.fileData,
                        date: new Date().toISOString()
                    });
                    alert("Document Uploaded!");
                    docForm.value = { empId: "", title: "", fileData: null, fileName: "" };
                };

                const deleteDocument = async (id) => {
                    if(confirm("Delete this document?")) await deleteDoc(doc(db, "employeeDocs", id));
                };

                // Call Logic
                const startCall = async () => {
                    inCall.value = true;
                    isSystemInCall.value = true;
                    const now = Date.now();
                    callStartTime.value = now;
                    await setDoc(doc(db, "systemState", "callActive"), { value: true });
                    await setDoc(doc(db, "systemState", "callStartTime"), { value: now });
                };
                const joinCall = () => { inCall.value = true; showNotification.value = false; };
                const joinCallFromNotif = () => { activeTab.value = 'team'; joinCall(); };
                const goToGoalsFromNotif = () => { activeTab.value = 'goals'; showNotification.value = false; };
                const endCall = async () => {
                    inCall.value = false;
                    if(currentUser.value.role === 'HR Admin') {
                        isSystemInCall.value = false;
                        await setDoc(doc(db, "systemState", "callActive"), { value: false });
                        await setDoc(doc(db, "systemState", "callStartTime"), { value: null });
                    }
                };

                // Leave & Tickets
                const submitLeave = async () => {
                    if(leaveForm.value.type === 'Other' && !leaveForm.value.customReason) { alert("Specify reason"); return; }
                    if(calculatedDays.value > currentUser.value.leaveBalance && !leaveForm.value.type.includes('Unpaid')) { alert("Insufficient Balance"); return; }
                    
                    await addDoc(collection(db, "requests"), { empId: currentUser.value.id, ...leaveForm.value, days: calculatedDays.value, status: 'Pending' });
                    
                    if(!leaveForm.value.type.includes('Unpaid')) {
                        const newBal = currentUser.value.leaveBalance - calculatedDays.value;
                        await updateDoc(doc(db, "employees", currentUser.value.id), { leaveBalance: newBal });
                    }
                    alert("Request Submitted");
                    leaveForm.value = { start: "", end: "", type: "Annual Leave", reason: "", customReason: "" };
                };

                const handleLeaveAction = async (id, status) => {
                    // Logic to refund balance if Denied
                    if (status === 'Denied') {
                         const reqSnap = await getDoc(doc(db, "requests", id));
                         if(reqSnap.exists()) {
                             const req = reqSnap.data();
                             if(req.status === 'Pending' && !req.type.includes('Unpaid')) {
                                 const empRef = doc(db, "employees", req.empId);
                                 const empSnap = await getDoc(empRef);
                                 if(empSnap.exists()) {
                                     await updateDoc(empRef, { leaveBalance: empSnap.data().leaveBalance + req.days });
                                 }
                             }
                         }
                    }
                    await updateDoc(doc(db, "requests", id), { status: status });
                };

                const submitTicket = async () => {
                    if(!ticketForm.value.description) return;
                    await addDoc(collection(db, "tickets"), { empId: currentUser.value.id, ...ticketForm.value, status: 'Open', date: new Date().toISOString() });
                    alert("Ticket Raised"); ticketForm.value.description = "";
                };
                const resolveTicket = async (id) => { await updateDoc(doc(db, "tickets", id), { status: 'Resolved' }); };

                // Chat
                const sendGroupMessage = async () => {
                    if(!groupChatInput.value.trim()) return;
                    await addDoc(collection(db, "groupChat"), { empId: currentUser.value.id, message: groupChatInput.value, time: new Date().toISOString() });
                    groupChatInput.value = "";
                };

                // Tasks
                const addTask = async () => {
                    if(!newTaskText.value.trim()) return;
                    const newTask = { id: Date.now(), text: newTaskText.value, done: false };
                    myTasks.value.unshift(newTask);
                    await updateDoc(doc(db, "employees", currentUser.value.id), { tasks: myTasks.value });
                    newTaskText.value = "";
                };
                const toggleTask = async (task) => {
                    task.done = !task.done;
                    await updateDoc(doc(db, "employees", currentUser.value.id), { tasks: myTasks.value });
                };

                // Helpers
                const getInitials = (id) => { const name = employeesMap.value[id] || "User"; return name.charAt(0); };
                const getEmployeeName = (id) => employeesMap.value[id] || id;
                const toggleChat = () => { isChatOpen.value = !isChatOpen.value; };
                const sendMessage = async () => {
                    if(!chatInput.value) return;
                    const text = chatInput.value; chatMessages.value.push({ isUser: true, text }); chatInput.value = ""; isTyping.value = true;
                    nextTick(() => { const el = document.getElementById('chatContainer'); if(el) el.scrollTop = el.scrollHeight; });
                    try {
                        // FIXED: Uses gemini-2.5-flash and logs errors
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: `You are an HR Assistant. Answer shortly. Query: ${text}` }] }] })
                        });
                        if (!response.ok) {
                             const errorData = await response.json();
                             console.error("Gemini Chat Error:", errorData);
                             throw new Error(errorData.error?.message || 'API Error');
                        }
                        const data = await response.json();
                        chatMessages.value.push({ isUser: false, text: data.candidates?.[0]?.content?.parts?.[0]?.text || "Error." });
                    } catch(e) { 
                        console.error(e);
                        chatMessages.value.push({ isUser: false, text: "Network/API Error. Check Console." }); 
                    }
                    isTyping.value = false; nextTick(() => { const el = document.getElementById('chatContainer'); if(el) el.scrollTop = el.scrollHeight; });
                };
                const parseMarkdown = (t) => marked.parse(t);
                const triggerFileInput = () => document.querySelector('input[type="file"]').click();
                const handlePhotoUpload = (e) => {
                    const file = e.target.files[0]; if(!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const base64 = ev.target.result;
                        await updateDoc(doc(db, "employees", currentUser.value.id), { photo: base64 });
                    };
                    reader.readAsDataURL(file);
                };

                const getCareerAdvice = async () => {
                    if (isAdvising.value) return;
                    isAdvising.value = true;
                    try {
                        const prompt = `Act as a career coach. My role is ${currentUser.value.role}. Give me 3 short, actionable tips for career growth in this specific role. Format as a markdown list.`;
                        // FIXED: Switched from gemini-2.5-flash (doesn't exist) to gemini-1.5-flash
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error("Gemini Career API Error:", errorData);
                            throw new Error(errorData.error?.message || "API Error");
                        }

                        const data = await response.json();
                        careerAdvice.value = data.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate advice.";
                    } catch (e) { 
                        console.error(e);
                        careerAdvice.value = "Error connecting to Career Coach. Check Console (F12)."; 
                    } 
                    finally { isAdvising.value = false; }
                };

                return {
                    currentUser, loginForm, activeTab, activeLoginPortal, navClass, login, logout,
                    leaveForm, leaveHistory, submitLeave, calculatedDays, statusClass,
                    ticketForm, myTickets, allTickets, submitTicket, resolveTicket, priorityClass,
                    groupChatInput, groupMessages, sendGroupMessage, getInitials,
                    updateStatus, statusColorClass, inCall, joinCall, allEmployees, startCall, endCall, isSystemInCall,
                    toggleChat, isChatOpen, chatInput, chatMessages, isTyping, sendMessage, parseMarkdown,
                    myTasks, newTaskText, addTask, toggleTask, getEmployeeName, handlePhotoUpload, triggerFileInput,
                    myGoals, saveGoals, assignedGoals, hrGoalForm, newGoalInput, addPersonalGoal, assignGoalToEmployee, updateAssignedGoal,
                    isEditingProfile, editProfileForm, toggleEditProfile, saveProfile,
                    showNotification, notificationMessage, notificationType, joinCallFromNotif, goToGoalsFromNotif,
                    currentTimeIST, callTimerFormatted, meetingNotes, saveMeetingNotes,
                    showPasswordPrompt, handleSavePassword,
                    massGoalText, assignGoalToAll, allEmployeeStats, calculateMyPerformance,
                    docsList, docForm, handleDocUpload, saveDocument, deleteDocument,
                    allLeaveRequests, handleLeaveAction, careerAdvice, isAdvising, getCareerAdvice
                };
            }
        }).mount('#app');
    </script>
</body>

</html>

